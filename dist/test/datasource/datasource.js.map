{"version":3,"sources":["../../../src/datasource/datasource.js"],"names":["KentikDatasource","instanceSettings","templateSrv","kentikProxySrv","name","kentik","value","variable","multi","includeAll","join","filterObj","operator","filterField","filterFieldDef","find","text","key","field","filterValue","filters","length","kentikFilters","map","convertToKentikFilter","connector","condition","toLowerCase","options","targets","Promise","resolve","data","target","deviceNames","replace","device","scopedVars","interpolateDeviceField","bind","getAdhocFilters","convertToKentikFilterGroup","query_options","range","from","to","metric","unit","kentikFilterGroups","query","formatQuery","invokeQuery","then","processResponse","mode","results","reject","message","bucketData","metricDef","dimension","unitDef","processTableData","processTimeSeries","seriesList","endIndex","topx","i","series","timeseries","timeSeries","flow","seriesName","grafana_series","datapoints","point","push","table","columns","tableFields","col","forEach","row","values","val","isString","parseFloat","rows","getDevices","devices","device_name","getFieldValues","result","toString"],"mappings":"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","file":"datasource.js","sourcesContent":["import {metricList, unitList, filterFieldList} from './metric_def';\nimport _ from 'lodash';\nimport TableModel from 'app/core/table_model';\nimport './kentikProxy';\n\nclass KentikDatasource {\n\n  constructor(instanceSettings, templateSrv, kentikProxySrv)  {\n    this.instanceSettings = instanceSettings;\n    this.name = instanceSettings.name;\n    this.templateSrv = templateSrv;\n    this.kentik = kentikProxySrv;\n  }\n\n  interpolateDeviceField(value, variable) {\n    // if no multi or include all do not regexEscape\n    if (!variable.multi && !variable.includeAll) {\n      return value;\n    }\n\n    if (typeof value === 'string') {\n      return value;\n    }\n\n    return value.join(',');\n  }\n\n  convertToKentikFilter(filterObj) {\n    // Use Kentik 'not equal' style\n    if (filterObj.operator === '!=') {\n      filterObj.operator = '<>';\n    }\n\n    // If no field definition found assume that custom field is used.\n    let filterField;\n    let filterFieldDef = _.find(filterFieldList, {text: filterObj.key});\n    if (filterFieldDef) {\n      filterField = filterFieldDef.field;\n    } else {\n      filterField = filterObj.key;\n    }\n\n    return {\n      filterField: filterField,\n      operator: filterObj.operator,\n      filterValue: filterObj.value\n    };\n  }\n\n  convertToKentikFilterGroup(filters) {\n    if (filters.length) {\n      let kentikFilters = _.map(filters, this.convertToKentikFilter);\n      let connector = 'All';\n      if (filters[0].condition && (\n          filters[0].condition.toLowerCase() === 'or' ||\n          filters[0].condition.toLowerCase() === 'any')) {\n        connector = 'Any';\n      }\n      return [{\n        \"connector\": connector,\n        \"filters\": kentikFilters,\n        \"not\": false,\n      }];\n    } else {\n      return [];\n    }\n  }\n\n  query(options) {\n    if (!options.targets || options.targets.length === 0) {\n      return Promise.resolve({data: []});\n    }\n\n    let target = options.targets[0];\n    let deviceNames = this.templateSrv.replace(target.device, options.scopedVars, this.interpolateDeviceField.bind(this));\n\n    let kentikFilters = this.templateSrv.getAdhocFilters(this.name);\n    kentikFilters = this.convertToKentikFilterGroup(kentikFilters);\n\n    let query_options = {\n      deviceNames: deviceNames,\n      range: {\n        from: options.range.from,\n        to: options.range.to\n      },\n      metric: this.templateSrv.replace(target.metric),\n      unit: this.templateSrv.replace(target.unit),\n      kentikFilterGroups: kentikFilters\n    };\n    let query = this.kentik.formatQuery(query_options);\n\n    return this.kentik.invokeQuery(query)\n    .then(this.processResponse.bind(this, query, target.mode, options));\n  }\n\n  processResponse(query, mode, options, data) {\n    if (!data.results) {\n      return Promise.reject({message: 'no kentik data'});\n    }\n\n    var bucketData = data.results[0].data;\n    if (bucketData.length === 0) {\n      return [];\n    }\n\n    var metricDef = _.find(metricList, {value: query.dimension[0]});\n    var unitDef = _.find(unitList, {value: query.metric});\n\n    if (mode === 'table') {\n      return this.processTableData(bucketData, metricDef, unitDef);\n    } else {\n      return this.processTimeSeries(bucketData, query, options);\n    }\n  }\n\n  processTimeSeries(bucketData, query) {\n    let seriesList = [];\n    let endIndex = query.topx;\n    if (bucketData.length < endIndex) {\n      endIndex = bucketData.length;\n    }\n\n    for (let i = 0; i < endIndex; i++) {\n      let series = bucketData[i];\n      let timeseries = _.find(series.timeSeries, series => {\n        return series.flow && series.flow.length;\n      });\n      let seriesName = series.key;\n\n      if (timeseries) {\n        let grafana_series = {\n          target: seriesName,\n          datapoints: timeseries.flow.map(point => {\n            return [point[1], point[0]];\n          })\n        };\n        seriesList.push(grafana_series);\n      }\n    }\n\n    return { data: seriesList };\n  }\n\n  processTableData(bucketData, metricDef, unitDef) {\n    var table = new TableModel();\n\n    table.columns.push({text: metricDef.text});\n\n    for (let col of unitDef.tableFields) {\n      table.columns.push({text: col.text, unit: col.unit});\n    }\n\n    bucketData.forEach(row => {\n      var seriesName = row.key;\n\n      var values = [seriesName];\n      for (let col of unitDef.tableFields) {\n        var val = row[col.field];\n\n        if (_.isString(val)) {\n          val = parseFloat(val);\n        }\n\n        values.push(val);\n      }\n\n      table.rows.push(values);\n    });\n\n    return {data: [table]};\n  }\n\n  metricFindQuery(query) {\n    if (query === 'metrics()') {\n      return Promise.resolve(metricList);\n    }\n    if (query === 'units()') {\n      return Promise.resolve(unitList);\n    }\n\n    return this.kentik.getDevices()\n    .then(devices => {\n      return devices.map(device => {\n        return {text: device.device_name, value: device.device_name};\n      });\n    });\n  }\n\n  getTagKeys() {\n    return Promise.resolve(filterFieldList);\n  }\n\n  getTagValues(options) {\n    if (options) {\n      let field = _.find(filterFieldList, {text: options.key}).field;\n      return this.kentik.getFieldValues(field)\n      .then(result => {\n        return result.rows.map(row => {\n          return {text: row[field].toString()};\n        });\n      });\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n}\n\nexport {KentikDatasource};\n"]}