{"version":3,"sources":["../../src/datasource/kentikAPI.js"],"names":["angular","_","unitList","KentikAPI","backendSrv","baseUrl","_get","then","response","data","devices","options","unitDef","find","value","unit","query","metric","range","from","utc","format","to","deviceNames","field","formatAggs","formatFilters","kentikFilterGroups","aggs","filters_obj","length","invokeSQLQuery","kentik_v5_query","_post","url","datasourceRequest","method","module","service"],"mappings":"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","file":"kentikAPI.js","sourcesContent":["import angular from 'angular';\nimport _ from 'lodash';\nimport {unitList} from './metric_def';\n\nclass KentikAPI {\n  constructor(backendSrv) {\n    this.backendSrv = backendSrv;\n    this.baseUrl = 'api/plugin-proxy/kentik-app';\n  }\n\n  getDevices() {\n    return this._get('/api/v5/devices')\n    .then(response => {\n      if (response.data && response.data.devices) {\n        return response.data.devices;\n      } else {\n        return [];\n      }\n    });\n  }\n\n  formatQuery(options) {\n    let unitDef = _.find(unitList, {value: options.unit});\n    let query = {\n      \"dimension\": [\n        options.metric\n      ],\n      \"metric\": options.unit,\n      \"matrixBy\": [],\n      \"cidr\": 32,\n      \"cidr6\": 128,\n      \"topx\": 8, // Visualization depth (8 by default)\n      \"depth\": 100,\n      \"fastData\": \"Auto\",\n      \"lookback_seconds\": 0,\n      \"time_format\": \"UTC\",\n      \"starting_time\": options.range.from.utc().format(\"YYYY-MM-DD HH:mm:ss\"),\n      \"ending_time\": options.range.to.utc().format(\"YYYY-MM-DD HH:mm:ss\"),\n      \"device_name\": options.deviceNames,\n      \"bucket\": \"\",\n      \"bucketIndex\": -1,\n      \"outsort\": unitDef.field,\n      \"aggregates\": this.formatAggs(unitDef),\n      \"filters_obj\": this.formatFilters(options.kentikFilterGroups)\n    };\n\n    return query;\n  }\n\n  formatAggs(unitDef) {\n    let aggs = [];\n    if (unitDef.field === \"f_countdistinct_inet_src_addr\" ||\n        unitDef.field === \"f_countdistinct_inet_dst_addr\") {\n      aggs = [\n      {\n        \"name\": unitDef.field,\n        \"column\": unitDef.field,\n        \"fn\": \"max\",\n        \"properName\": \"Max\",\n        \"sortable\": true,\n        \"raw\": true,\n        \"sample_rate\": 1\n      },\n      {\n        \"name\": \"p95th_bits_per_sec\",\n        \"column\": \"f_sum_both_bytes\",\n        \"fn\": \"percentile\",\n        \"rank\": 95,\n        \"sample_rate\": 1\n      },\n      {\n        \"name\": \"p95th_pkts_per_sec\",\n        \"column\": \"f_sum_both_pkts\",\n        \"fn\": \"percentile\",\n        \"rank\": 95,\n        \"sample_rate\": 1\n      }];\n    } else {\n      aggs = [\n      {\n        \"name\": unitDef.field, // avg_bits_per_sec\n        \"column\": unitDef.field,\n        \"fn\": \"average\",\n        \"properName\": \"Average\",\n        \"raw\": true, // Set to get timeseries data\n        \"sortable\": true,\n        \"sample_rate\": 1\n      },\n      {\n        \"name\": \"p95th_both\",\n        \"column\": unitDef.field,\n        \"fn\": \"percentile\",\n        \"rank\": 95,\n        \"properName\": \"95th Percentile\",\n        \"sortable\": true,\n        \"sample_rate\": 1\n      },\n      {\n        \"name\": \"max_both\",\n        \"column\": unitDef.field,\n        \"fn\": \"max\",\n        \"properName\": \"Max\",\n        \"sortable\": true,\n        \"raw\": true,\n        \"sample_rate\": 1\n      }];\n    }\n    return aggs;\n  }\n\n  formatFilters(kentikFilterGroups) {\n    let filters_obj = {};\n    if (kentikFilterGroups.length) {\n      filters_obj = {\n        \"connector\": \"All\",\n        \"custom\": false,\n        \"filterGroups\": kentikFilterGroups,\n        \"filterString\": \"\"\n      };\n    }\n\n    return filters_obj;\n  }\n\n  getFieldValues(field) {\n    let query = `SELECT DISTINCT ${field} FROM all_devices ORDER BY ${field} ASC`;\n    return this.invokeSQLQuery(query);\n  }\n\n  invokeQuery(query) {\n    let kentik_v5_query = {\n      \"queries\": [\n        {\n          \"query\": query,\n          \"bucketIndex\": 0,\n          \"isOverlay\": false\n        }\n      ]\n    };\n\n    return this._post('/api/v5/query/topXdata', kentik_v5_query);\n  }\n\n  invokeSQLQuery(query) {\n    let data = {\n      \"query\": query\n    };\n\n    return this._post('/api/v5/query/sql', data);\n  }\n\n  _get(url) {\n    return this.backendSrv.datasourceRequest({\n      method: 'GET',\n      url: this.baseUrl + url,\n    });\n  }\n\n  _post(url, data) {\n    return this.backendSrv.datasourceRequest({\n      method: 'POST',\n      url: this.baseUrl + url,\n      data: data\n    })\n    .then(response => {\n      if (response.data) {\n        return response.data;\n      } else {\n        return [];\n      }\n    });\n  }\n}\n\nangular\n  .module('grafana.services')\n  .service('kentikAPISrv', KentikAPI);\n"]}