define(["lodash","app/plugins/sdk","angular","moment","app/core/table_model"],function(e,t,r,n,i){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=13)}([function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t){e.exports=r},,,,,,function(e,t){e.exports=n},function(e,t){e.exports=i},,,,function(e,t,r){"use strict";r.r(t);var n=[{text:"Traffic",value:"Traffic",field:"traffic"},{text:"Source Country",value:"Geography_src",field:"src_geo"},{text:"Source Geo Region",value:"src_geo_region",field:"src_geo_region"},{text:"Source Geo City",value:"src_geo_city",field:"src_geo_city"},{text:"Source As Number",value:"AS_src",field:"src_as"},{text:"Source Interface",value:"InterfaceID_src",field:"input_port"},{text:"Source Port",value:"Port_src",field:"l4_src_port"},{text:"Source VLAN",value:"VLAN_src",field:"vlan_in"},{text:"Source IP/CIDR",value:"IP_src",field:"ipv4_src_addr"},{text:"Source Route Prefix/LEN",value:"src_route_prefix_len",field:"src_route_prefix_len"},{text:"Source Route LEN",value:"src_route_length",field:"src_route_length"},{text:"Source BGP Community",value:"src_bgp_community",field:"src_bgp_community"},{text:"Source BGP AS_Path",value:"src_bgp_aspath",field:"src_bgp_aspath"},{text:"Source BGP Next Hop IP/CIDR",value:"src_nexthop_ip",field:"ipv4_src_next_hop"},{text:"Source Next Hop AS Number",value:"src_nexthop_asn",field:"src_nexthop_as"},{text:"Source 2nd BGP_HOP AS Number",value:"src_second_asn",field:"src_second_asn"},{text:"Source 3nd BGP_HOP AS Number",value:"src_third_asn",field:"src_third_asn"},{text:"Source Protocol:IP Port",value:"src_proto_port",field:"src_proto_port"},{text:"Destination Country",value:"Geography_dst",field:"dst_geo"},{text:"Destination Region",value:"dst_geo_region",field:"dst_geo_region"},{text:"Destination City",value:"dst_geo_city",field:"dst_geo_city"},{text:"Destination As Number",value:"AS_dst",field:"dst_as"},{text:"Destination Interface",value:"InterfaceID_dst",field:"output_port"},{text:"Destination Port",value:"Port_dst",field:"l4_dst_port"},{text:"Destination VLAN",value:"VLAN_dst",field:"vlan_out"},{text:"Destination IP/CIDR",value:"IP_dst",field:"ipv4_dst_addr"},{text:"Destination Route Prefix/LEN",value:"dst_route_prefix_len",field:"dst_route_prefix_len"},{text:"Destination Route LEN",value:"dst_route_prefix_len",field:"dst_route_length"},{text:"Destination BGP Community",value:"dst_bgp_community",field:"dst_bgp_community"},{text:"Destination BGP AS_Path",value:"dst_bgp_aspath",field:"dst_bgp_aspath"},{text:"Destination BGP Next Hop IP/CIDR",value:"dst_nexthop_ip",field:"ipv4_dst_next_hop"},{text:"Destination Next Hop AS Number",value:"dst_nexthop_asn",field:"dst_nexthop_as"},{text:"Destination 2nd BGP_HOP AS Number",value:"dst_second_asn",field:"dst_second_asn"},{text:"Destination 3nd BGP_HOP AS Number",value:"dst_third_asn",field:"dst_third_asn"},{text:"Destination Protocol:IP Port",value:"dst_proto_port",field:"dst_proto_port"},{text:"Full TOS",value:"TOS",field:"tos"},{text:"Full Protocol",value:"Proto",field:"protocl"}];var i=[{text:"Bits/s",value:"bytes",field:"f_sum_both_bytes",outsort:"avg_both",gfUnit:"bps",gfAxisLabel:"Bits/s",transform:function(e,t){return 8*e/t.i_duration},tableFields:[{text:"Avg",field:"avg_both",unit:"bps",transform:function(e,t,r){return 8*e/r}},{text:"95th Percentile",field:"p95th_both",unit:"bps"},{text:"Max",field:"max_both",unit:"bps"}]},{text:"Packets/s",value:"packets",field:"f_sum_both_pkts",outsort:"avg_both",gfUnit:"pps",gfAxislabel:"Packets/s",transform:function(e,t){return e/t.i_duration},tableFields:[{text:"Avg",field:"avg_both",unit:"pps",transform:function(e,t,r){return e/r}},{text:"95th Percentile",field:"p95th_both",unit:"pps"},{text:"Max",field:"max_both",unit:"pps"}]},{text:"Unique Src IPs",value:"unique_src_ip",field:"f_hll(inet_src_addr,0.0001)",outsort:"avg_ips",gfUnit:"short",gfAxisLabel:"Unique Src IPs",tableFields:[{text:"Average",field:"avg_ips",unit:"none"},{text:"p95th",field:"p95th_ips",unit:"none"},{text:"Max",field:"max_ips",unit:"none"},{text:"p95th mbps",field:"p95th_bits_per_sec",unit:"bps"},{text:"p95th pps",field:"p95th_pkts_per_sec",unit:"pps"}]},{text:"Unique Dst IPs",value:"unique_dst_ip",field:"f_hll(inet_dst_addr,0.0001)",outsort:"avg_ips",gfUnit:"short",gfAxisLabel:"Unique Dst IPs",tableFields:[{text:"Average",field:"avg_ips",unit:"none"},{text:"p95th",field:"p95th_ips",unit:"none"},{text:"Max",field:"max_ips",unit:"none"},{text:"p95th mbps",field:"p95th_bits_per_sec",unit:"bps"},{text:"p95th pps",field:"p95th_pkts_per_sec",unit:"pps"}]}],o=[{text:"Source City",field:"src_geo_city"},{text:"Source Region",field:"src_geo_region"},{text:"Source Country",field:"src_geo"},{text:"Source AS Number",field:"src_as"},{text:"Source AS Name",field:"src_as_name"},{text:"Source Flow Tag",field:"src_flow_tags"},{text:"Source IP Port",field:"l4_src_port"},{text:"Source MAC Address",field:"src_eth_mac"},{text:"Source VLAN",field:"vlan_in"},{text:"Source IP Address",field:"inet_src_addr"},{text:"Source Interface ID",field:"input_port"},{text:"Source Interface Name",field:"i_input_interface_description"},{text:"Source Interface Description",field:"i_input_snmp_alias"},{text:"Source Route Prefix",field:"ipv4_src_route_prefix"},{text:"Source Route LEN",field:"src_route_length"},{text:"Source BGP AS_PATH",field:"src_bgp_aspath"},{text:"Source BGP Community",field:"src_bgp_community"},{text:"Source Next Hop IP/CIDR",field:"ipv4_src_next_hop"},{text:"Source Next Hop AS Number",field:"src_nexthop_as"},{text:"Source Next Hop AS Name",field:"src_nexthop_as_name"},{text:"Source 2nd BGP_HOP AS Number",field:"src_second_asn"},{text:"Source 2nd BGP_HOP AS Name",field:"src_second_asn_name"},{text:"Source 3nd BGP_HOP AS Number",field:"src_third_asn"},{text:"Source 3nd BGP_HOP AS Name",field:"src_third_asn_name"},{text:"Destination City",field:"dst_geo_city"},{text:"Destination Region",field:"dst_geo_region"},{text:"Destination Country",field:"dst_geo"},{text:"Destination AS Number",field:"dst_as"},{text:"Destination AS Name",field:"dst_as_name"},{text:"Destination Flow Tag",field:"dst_flow_tags"},{text:"Destination IP Port",field:"l4_dst_port"},{text:"Destination MAC Address",field:"dst_eth_mac"},{text:"Destination VLAN",field:"vlan_out"},{text:"Destination IP Address",field:"inet_dst_addr"},{text:"Destination Interface ID",field:"output_port"},{text:"Destination Interface Name",field:"i_output_interface_description"},{text:"Destination Interface Description",field:"i_output_snmp_alias"},{text:"Destination Route Prefix",field:"ipv4_dst_route_prefix"},{text:"Destination Route LEN",field:"dst_route_length"},{text:"Destination BGP AS_PATH",field:"dst_bgp_aspath"},{text:"Destination BGP Community",field:"dst_bgp_community"},{text:"Destination Next Hop IP/CIDR",field:"ipv4_dst_next_hop"},{text:"Destination Next Hop AS Number",field:"dst_nexthop_as"},{text:"Destination Next Hop AS Name",field:"dst_nexthop_as_name"},{text:"Destination 2nd BGP_HOP AS Number",field:"dst_second_asn"},{text:"Destination 2nd BGP_HOP AS Name",field:"dst_second_asn_name"},{text:"Destination 3nd BGP_HOP AS Number",field:"dst_third_asn"},{text:"Destination 3nd BGP_HOP AS Name",field:"dst_third_asn_name"},{text:"TCP Flags",field:"tcp_flags"},{text:"TCP Flags (raw)",field:"tcp_flags_raw"},{text:"Protocol",field:"protocol"},{text:"INET Family",field:"inet_family"},{text:"Device Name",field:"i_device_name"},{text:"TCP Retransmits",field:"tcp_retransmit"},{text:"TOS/Diffserv",field:"tos"},{text:"Per-flow packets (both in and out)",field:"both_pkts"},{text:"Per-flow packets (recorded inbound)",field:"in_pkts"},{text:"Per-flow bytes (recorded inbound)",field:"in_bytes"},{text:"Per-flow packets (recorded outbound)",field:"out_pkts"},{text:"Per-flow bytes (recorded outbound)",field:"out_bytes"}],a=r(0),s=r.n(a),u=r(2),l=r.n(u),c=r(8),_=r.n(c),d=function(){function e(e){this.backendSrv=e,this.baseUrl="api/plugin-proxy/kentik-app"}return e.$inject=["backendSrv"],e.prototype.getDevices=function(){return this._get("/api/v5/devices").then(function(e){return e.data&&e.data.devices?e.data.devices:[]})},e.prototype.getFieldValues=function(e){var t="SELECT DISTINCT "+e+" FROM all_devices ORDER BY "+e+" ASC";return this.invokeSQLQuery(t)},e.prototype.invokeTopXDataQuery=function(e){var t={queries:[{query:e,bucketIndex:0}]};return this._post("/api/v5/query/topXdata",t)},e.prototype.invokeSQLQuery=function(e){var t={query:e};return this._post("/api/v5/query/sql",t)},e.prototype._get=function(e){return this.backendSrv.datasourceRequest({method:"GET",url:this.baseUrl+e}).catch(function(e){return console.log(e),e.err?Promise.reject(e.err):Promise.reject(e)})},e.prototype._post=function(e,t){return this.backendSrv.datasourceRequest({method:"POST",url:this.baseUrl+e,data:t}).then(function(e){return e.data?e.data:[]}).catch(function(e){return console.log(e),e.err?Promise.reject(e.err):Promise.reject(e)})},e}();function f(){var e=new Date;return e.getTime()+60*e.getTimezoneOffset()*1e3}function p(e){var t=s.a.cloneDeep(e);return t.starting_time=null,t.ending_time=null,JSON.stringify(t)}l.a.module("grafana.services").service("kentikAPISrv",d);var m=function(){function e(e,t){this.kentikAPI=t,this.cache={},this.cacheUpdateInterval=3e5,this.requestCachingIntervals={"1d":0},this.getDevices=this.kentikAPI.getDevices.bind(this.kentikAPI)}return e.$inject=["backendSrv","kentikAPISrv"],e.prototype.invokeTopXDataQuery=function(e){var t=this,r=s.a.cloneDeep(e),n=p(r);return this.shouldInvoke(e)?this.kentikAPI.invokeTopXDataQuery(e).then(function(e){var i=f();return t.cache[n]={timestamp:i,query:r,result:e},console.log("Invoke Kentik query"),e}):(console.log("Get result from cache"),Promise.resolve(this.cache[n].result))},e.prototype.shouldInvoke=function(e){var t=e,r=p(t),n=f(),i=Date.parse(t.starting_time),o=Date.parse(t.ending_time),a=o-i,s=this.cache[r]?Date.parse(this.cache[r].query.starting_time):null,u=this.cache[r]?Date.parse(this.cache[r].query.ending_time):null,l=u-s,c=function(e){var t=Date.parse(e.ending_time)-Date.parse(e.starting_time);return t>_.a.duration(1,"months")?36e5:t>_.a.duration(1,"day")?9e5:3e5}(t);return!this.cache[r]||n-o>c||this.cache[r]&&(n-u>c||i<s||Math.abs(a-l)>6e4)},e.prototype.getFieldValues=function(e){var t=this,r=f();return this.cache[e]&&r-this.cache[e].ts<this.cacheUpdateInterval?Promise.resolve(this.cache[e].value):this.kentikAPI.getFieldValues(e).then(function(n){return r=f(),t.cache[e]={ts:r,value:n},n})},e}();l.a.module("grafana.services").service("kentikProxySrv",m);var x=r(9),h=r.n(x),v="YYYY-MM-DD HH:mm:ss";function g(e){return"unique_src_ip"===e.value||"unique_dst_ip"===e.value?function(e){return[{name:"avg_ips",column:e.field,fn:"average",raw:!0,sample_rate:1},{name:"p95th_ips",column:e.field,fn:"percentile",rank:95,sample_rate:1},{name:"max_ips",column:e.field,fn:"max",sample_rate:1,raw:!0},{name:"p95th_bits_per_sec",column:"f_sum_both_bytes",fn:"percentile",rank:95,sample_rate:1},{name:"p95th_pkts_per_sec",column:"f_sum_both_pkts",fn:"percentile",rank:95,sample_rate:1}]}(e):function(e){return[{name:"avg_both",column:e.field,fn:"average",raw:!0,sample_rate:1},{name:"p95th_both",column:e.field,fn:"percentile",rank:95,sample_rate:1},{name:"max_both",column:e.field,fn:"max",sample_rate:1}]}(e)}function b(e){"!="===e.operator&&(e.operator="<>");var t=s.a.find(o,{text:e.key});return{filterField:t?t.field:e.key,operator:e.operator,filterValue:e.value}}var P={buildTopXdataQuery:function(e){var t=s.a.find(i,{value:e.unit}),r=e.range.from.utc().format(v),n=e.range.to.utc().format(v);return{dimension:[e.metric],metric:e.unit,matrixBy:[],cidr:32,cidr6:128,topx:"8",depth:100,fastData:"Auto",lookback_seconds:0,time_format:"UTC",starting_time:r,ending_time:n,device_name:e.deviceNames,outsort:t.outsort,aggregates:g(t),filters_obj:function(e){var t={connector:"All",filterGroups:[]};return e.length&&(t.filterGroups=e),t}(e.kentikFilterGroups)}},formatAggs:g,convertToKentikFilterGroup:function(e){if(e.length){var t=s.a.map(e,b),r="All";return!e[0].condition||"or"!==e[0].condition.toLowerCase()&&"any"!==e[0].condition.toLowerCase()||(r="Any"),[{connector:r,filters:t,not:!1}]}return[]}},S=function(){function e(e,t,r){this.instanceSettings=e,this.templateSrv=t,this.name=e.name,this.kentik=r}return e.$inject=["instanceSettings","templateSrv","kentikProxySrv"],e.prototype.interpolateDeviceField=function(e,t){return t.multi||t.includeAll?"string"==typeof e?e:e.join(","):e},e.prototype.query=function(e){if(!e.targets||0===e.targets.length)return Promise.resolve({data:[]});var t=e.targets[0],r=this.templateSrv.replace(t.device,e.scopedVars,this.interpolateDeviceField.bind(this)),n=this.templateSrv.getAdhocFilters(this.name);n=P.convertToKentikFilterGroup(n);var i={deviceNames:r,range:{from:e.range.from,to:e.range.to},metric:this.templateSrv.replace(t.metric),unit:this.templateSrv.replace(t.unit),kentikFilterGroups:n},o=P.buildTopXdataQuery(i);return this.kentik.invokeTopXDataQuery(o).then(this.processResponse.bind(this,o,t.mode,e)).then(function(e){return{data:e}})},e.prototype.processResponse=function(e,t,r,o){if(!o.results)return Promise.reject({message:"no kentik data"});var a=o.results[0].data;if(0===a.length)return[];var u=s.a.find(n,{value:e.dimension[0]}),l=s.a.find(i,{value:e.metric});return"table"===t?this.processTableData(a,u,l):this.processTimeSeries(a,e,r)},e.prototype.processTimeSeries=function(e,t,r){var n=[],i=t.topx;e.length<i&&(i=e.length);for(var o=0;o<i;o++){var a=e[o],u=s.a.find(a.timeSeries,function(e){return e.flow&&e.flow.length}),l=a.key;if(u){var c={target:l,datapoints:s.a.map(u.flow,function(e){return[e[1],e[0]]})};n.push(c)}}return n},e.prototype.processTableData=function(e,t,r){var n=new h.a;n.columns.push({text:t.text});for(var i=0,o=r.tableFields;i<o.length;i++){var a=o[i];n.columns.push({text:a.text,unit:a.unit})}return s.a.forEach(e,function(e){for(var t=[e.key],i=0,o=r.tableFields;i<o.length;i++){var a=e[o[i].field];s.a.isString(a)&&(a=parseFloat(a)),t.push(a)}n.rows.push(t)}),[n]},e.prototype.metricFindQuery=function(e){return"metrics()"===e?Promise.resolve(n):"units()"===e?Promise.resolve(i):this.kentik.getDevices().then(function(e){return e.map(function(e){return{text:e.device_name,value:e.device_name}})})},e.prototype.getTagKeys=function(){return Promise.resolve(o)},e.prototype.getTagValues=function(e){if(e){var t=s.a.find(o,{text:e.key}).field;return this.kentik.getFieldValues(t).then(function(e){return e.rows.map(function(e){return{text:e[t].toString()}})})}return Promise.resolve([])},e}(),y=function(){function e(){}return e.templateUrl="datasource/config.html",e}(),D=r(1),k=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),A=function(e){function t(t,r){var n=e.call(this,t,r)||this;return n.target.mode=n.target.mode||"graph",n.queryModes=[{value:"graph",text:"Graph"},{value:"table",text:"Table"}],n}return k(t,e),t.$inject=["$scope","$injector"],t}(D.QueryCtrl);A.templateUrl="datasource/query_editor.html",r.d(t,"Datasource",function(){return S}),r.d(t,"ConfigCtrl",function(){return y}),r.d(t,"QueryCtrl",function(){return A})}])});
//# sourceMappingURL=module.js.map