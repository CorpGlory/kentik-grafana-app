define(["lodash","app/plugins/sdk","angular","moment","app/core/table_model"],function(e,t,n,r,i){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=13)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},,,,,,function(e,t){e.exports=r},function(e,t){e.exports=i},,,,function(e,t,n){"use strict";n.r(t);var r=[{text:"Traffic",value:"Traffic",field:"traffic"},{text:"TopFlow",value:"TopFlow",field:"TopFlow"},{text:"Top flow IP",value:"TopFlowsIP",field:"TopFlowsIP"},{text:"Source Country",value:"Geography_src",field:"src_geo"},{text:"Source Geo Region",value:"src_geo_region",field:"src_geo_region"},{text:"Source Geo City",value:"src_geo_city",field:"src_geo_city"},{text:"Source As Number",value:"AS_src",field:"src_as"},{text:"Source Interface",value:"InterfaceID_src",field:"input_port"},{text:"Source Port",value:"Port_src",field:"l4_src_port"},{text:"Source VLAN",value:"VLAN_src",field:"vlan_in"},{text:"Source IP/CIDR",value:"IP_src",field:"ipv4_src_addr"},{text:"Source MAC Address",value:"src_eth_mac",field:"src_eth_mac"},{text:"Source Route Prefix/LEN",value:"src_route_prefix_len",field:"src_route_prefix_len"},{text:"Source Route LEN",value:"src_route_length",field:"src_route_length"},{text:"Source BGP Community",value:"src_bgp_community",field:"src_bgp_community"},{text:"Source BGP AS_Path",value:"src_bgp_aspath",field:"src_bgp_aspath"},{text:"Source BGP Next Hop IP/CIDR",value:"src_nexthop_ip",field:"ipv4_src_next_hop"},{text:"Source Next Hop AS Number",value:"src_nexthop_asn",field:"src_nexthop_as"},{text:"Source 2nd BGP_HOP AS Number",value:"src_second_asn",field:"src_second_asn"},{text:"Source 3nd BGP_HOP AS Number",value:"src_third_asn",field:"src_third_asn"},{text:"Source Protocol:IP Port",value:"src_proto_port",field:"src_proto_port"},{text:"Destination Country",value:"Geography_dst",field:"dst_geo"},{text:"Destination Region",value:"dst_geo_region",field:"dst_geo_region"},{text:"Destination City",value:"dst_geo_city",field:"dst_geo_city"},{text:"Destination As Number",value:"AS_dst",field:"dst_as"},{text:"Destination Interface",value:"InterfaceID_dst",field:"output_port"},{text:"Destination Port",value:"Port_dst",field:"l4_dst_port"},{text:"Destination VLAN",value:"VLAN_dst",field:"vlan_out"},{text:"Destination IP/CIDR",value:"IP_dst",field:"ipv4_dst_addr"},{text:"Destination MAC Address",value:"dst_eth_mac",field:"dst_eth_mac"},{text:"Destination Route Prefix/LEN",value:"dst_route_prefix_len",field:"dst_route_prefix_len"},{text:"Destination Route LEN",value:"dst_route_length",field:"dst_route_length"},{text:"Destination BGP Community",value:"dst_bgp_community",field:"dst_bgp_community"},{text:"Destination BGP AS_Path",value:"dst_bgp_aspath",field:"dst_bgp_aspath"},{text:"Destination BGP Next Hop IP/CIDR",value:"dst_nexthop_ip",field:"ipv4_dst_next_hop"},{text:"Destination Next Hop AS Number",value:"dst_nexthop_asn",field:"dst_nexthop_as"},{text:"Destination 2nd BGP_HOP AS Number",value:"dst_second_asn",field:"dst_second_asn"},{text:"Destination 3nd BGP_HOP AS Number",value:"dst_third_asn",field:"dst_third_asn"},{text:"Destination Protocol:IP Port",value:"dst_proto_port",field:"dst_proto_port"},{text:"Full Device",value:"i_device_id",field:"i_device_id"},{text:"Full Site",value:"i_device_site_name",field:"i_device_site_name"},{text:"Full Protocol",value:"Proto",field:"protocl"},{text:"Full INET Family",value:"inet_family",field:"inet_family"},{text:"Full TOS",value:"TOS",field:"tos"},{text:"Full TCP flags",value:"tcp_flags",field:"tcp_flags"},{text:"AS Top Talkers",value:"ASTopTalkers",field:"ASTopTalkers"},{text:"Interface Top Talkers",value:"InterfaceTopTalkers",field:"InterfaceTopTalkers"},{text:"Port to Port Talkers",value:"PortPortTalkers",field:"PortPortTalkers"},{text:"Region Top Talkers",value:"RegionTopTalkers",field:"RegionTopTalkers"}];var i=[{text:"Bits/s",value:"bytes",field:"f_sum_both_bytes",outsort:"avg_both",gfUnit:"bps",gfAxisLabel:"Bits/s",transform:function(e,t){return 8*e/t.i_duration},tableFields:[{text:"Avg",field:"avg_both",unit:"bps",transform:function(e,t,n){return 8*e/n}},{text:"95th Percentile",field:"p95th_both",unit:"bps"},{text:"Max",field:"max_both",unit:"bps"}]},{text:"Packets/s",value:"packets",field:"f_sum_both_pkts",outsort:"avg_both",gfUnit:"pps",gfAxislabel:"Packets/s",transform:function(e,t){return e/t.i_duration},tableFields:[{text:"Avg",field:"avg_both",unit:"pps",transform:function(e,t,n){return e/n}},{text:"95th Percentile",field:"p95th_both",unit:"pps"},{text:"Max",field:"max_both",unit:"pps"}]},{text:"Unique Src IPs",value:"unique_src_ip",field:"f_hll(inet_src_addr,0.0001)",outsort:"avg_ips",gfUnit:"short",gfAxisLabel:"Unique Src IPs",tableFields:[{text:"Average",field:"avg_ips",unit:"none"},{text:"p95th",field:"p95th_ips",unit:"none"},{text:"Max",field:"max_ips",unit:"none"},{text:"p95th mbps",field:"p95th_bits_per_sec",unit:"bps"},{text:"p95th pps",field:"p95th_pkts_per_sec",unit:"pps"}]},{text:"Unique Dst IPs",value:"unique_dst_ip",field:"f_hll(inet_dst_addr,0.0001)",outsort:"avg_ips",gfUnit:"short",gfAxisLabel:"Unique Dst IPs",tableFields:[{text:"Average",field:"avg_ips",unit:"none"},{text:"p95th",field:"p95th_ips",unit:"none"},{text:"Max",field:"max_ips",unit:"none"},{text:"p95th mbps",field:"p95th_bits_per_sec",unit:"bps"},{text:"p95th pps",field:"p95th_pkts_per_sec",unit:"pps"}]}],o=[{text:"Source City",field:"src_geo_city"},{text:"Source Region",field:"src_geo_region"},{text:"Source Country",field:"src_geo"},{text:"Source AS Number",field:"src_as"},{text:"Source AS Name",field:"src_as_name"},{text:"Source Flow Tag",field:"src_flow_tags"},{text:"Source IP Port",field:"l4_src_port"},{text:"Source MAC Address",field:"src_eth_mac"},{text:"Source VLAN",field:"vlan_in"},{text:"Source IP Address",field:"inet_src_addr"},{text:"Source Interface ID",field:"input_port"},{text:"Source Interface Name",field:"i_input_interface_description"},{text:"Source Interface Description",field:"i_input_snmp_alias"},{text:"Source Route Prefix",field:"ipv4_src_route_prefix"},{text:"Source Route LEN",field:"src_route_length"},{text:"Source BGP AS_PATH",field:"src_bgp_aspath"},{text:"Source BGP Community",field:"src_bgp_community"},{text:"Source Next Hop IP/CIDR",field:"ipv4_src_next_hop"},{text:"Source Next Hop AS Number",field:"src_nexthop_as"},{text:"Source Next Hop AS Name",field:"src_nexthop_as_name"},{text:"Source 2nd BGP_HOP AS Number",field:"src_second_asn"},{text:"Source 2nd BGP_HOP AS Name",field:"src_second_asn_name"},{text:"Source 3nd BGP_HOP AS Number",field:"src_third_asn"},{text:"Source 3nd BGP_HOP AS Name",field:"src_third_asn_name"},{text:"Destination City",field:"dst_geo_city"},{text:"Destination Region",field:"dst_geo_region"},{text:"Destination Country",field:"dst_geo"},{text:"Destination AS Number",field:"dst_as"},{text:"Destination AS Name",field:"dst_as_name"},{text:"Destination Flow Tag",field:"dst_flow_tags"},{text:"Destination IP Port",field:"l4_dst_port"},{text:"Destination MAC Address",field:"dst_eth_mac"},{text:"Destination VLAN",field:"vlan_out"},{text:"Destination IP Address",field:"inet_dst_addr"},{text:"Destination Interface ID",field:"output_port"},{text:"Destination Interface Name",field:"i_output_interface_description"},{text:"Destination Interface Description",field:"i_output_snmp_alias"},{text:"Destination Route Prefix",field:"ipv4_dst_route_prefix"},{text:"Destination Route LEN",field:"dst_route_length"},{text:"Destination BGP AS_PATH",field:"dst_bgp_aspath"},{text:"Destination BGP Community",field:"dst_bgp_community"},{text:"Destination Next Hop IP/CIDR",field:"ipv4_dst_next_hop"},{text:"Destination Next Hop AS Number",field:"dst_nexthop_as"},{text:"Destination Next Hop AS Name",field:"dst_nexthop_as_name"},{text:"Destination 2nd BGP_HOP AS Number",field:"dst_second_asn"},{text:"Destination 2nd BGP_HOP AS Name",field:"dst_second_asn_name"},{text:"Destination 3nd BGP_HOP AS Number",field:"dst_third_asn"},{text:"Destination 3nd BGP_HOP AS Name",field:"dst_third_asn_name"},{text:"TCP Flags",field:"tcp_flags"},{text:"TCP Flags (raw)",field:"tcp_flags_raw"},{text:"Protocol",field:"protocol"},{text:"INET Family",field:"inet_family"},{text:"Device Name",field:"i_device_name"},{text:"TCP Retransmits",field:"tcp_retransmit"},{text:"TOS/Diffserv",field:"tos"},{text:"Per-flow packets (both in and out)",field:"both_pkts"},{text:"Per-flow packets (recorded inbound)",field:"in_pkts"},{text:"Per-flow bytes (recorded inbound)",field:"in_bytes"},{text:"Per-flow packets (recorded outbound)",field:"out_pkts"},{text:"Per-flow bytes (recorded outbound)",field:"out_bytes"}],s=n(0),a=n(2),u=n.n(a),l=n(8),c=function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})},d=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},f=function(){function e(e){this.backendSrv=e,this.baseUrl="api/plugin-proxy/kentik-app"}return e.$inject=["backendSrv"],e.prototype.getDevices=function(){return this._get("/api/v5/devices").then(function(e){return e.data&&e.data.devices?e.data.devices:[]})},e.prototype.getFieldValues=function(e){var t="SELECT DISTINCT "+e+" FROM all_devices ORDER BY "+e+" ASC";return this.invokeSQLQuery(t)},e.prototype.getCustomDimensions=function(){return c(this,void 0,void 0,function(){return d(this,function(e){switch(e.label){case 0:return[4,this._get("/api/v5/customdimensions")];case 1:return[2,e.sent().data.customDimensions]}})})},e.prototype.getSavedFilters=function(){return c(this,void 0,void 0,function(){return d(this,function(e){switch(e.label){case 0:return[4,this._get("/api/v5/saved-filters")];case 1:return[2,e.sent().data]}})})},e.prototype.invokeTopXDataQuery=function(e){var t={queries:[{query:e,bucketIndex:0}]};return this._post("/api/v5/query/topXdata",t)},e.prototype.invokeSQLQuery=function(e){var t={query:e};return this._post("/api/v5/query/sql",t)},e.prototype._get=function(e){return this.backendSrv.datasourceRequest({method:"GET",url:this.baseUrl+e}).catch(function(e){return console.log(e),e.err?Promise.reject(e.err):Promise.reject(e)})},e.prototype._post=function(e,t){return this.backendSrv.datasourceRequest({method:"POST",url:this.baseUrl+e,data:t}).then(function(e){return e.data?e.data:[]}).catch(function(e){return console.log(e),e.err?Promise.reject(e.err):Promise.reject(e)})},e}();u.a.module("grafana.services").service("kentikAPISrv",f);var p=function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})},_=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};function h(){var e=new Date;return e.getTime()+60*e.getTimezoneOffset()*1e3}function v(e){var t=s.cloneDeep(e);return t.starting_time=null,t.ending_time=null,JSON.stringify(t)}var m=function(){function e(e,t){this.kentikAPI=t,this.cache={},this.cacheUpdateInterval=3e5,this.requestCachingIntervals={"1d":0},this.getDevices=this.kentikAPI.getDevices.bind(this.kentikAPI)}return e.$inject=["backendSrv","kentikAPISrv"],e.prototype.invokeTopXDataQuery=function(e){var t=this,n=s.cloneDeep(e),r=v(n);return this.shouldInvoke(e)?this.kentikAPI.invokeTopXDataQuery(e).then(function(e){var i=h();return t.cache[r]={timestamp:i,query:n,result:e},console.log("Invoke Kentik query"),e}):(console.log("Get result from cache"),Promise.resolve(this.cache[r].result))},e.prototype.shouldInvoke=function(e){var t=e,n=v(t),r=h(),i=Date.parse(t.starting_time),o=Date.parse(t.ending_time),s=o-i,a=this.cache[n]?Date.parse(this.cache[n].query.starting_time):null,u=this.cache[n]?Date.parse(this.cache[n].query.ending_time):null,c=u-a,d=function(e){var t=Date.parse(e.ending_time)-Date.parse(e.starting_time);return t>l.duration(1,"months")?36e5:t>l.duration(1,"day")?9e5:3e5}(t);return!this.cache[n]||r-o>d||this.cache[n]&&(r-u>d||i<a||Math.abs(s-c)>6e4)},e.prototype.getFieldValues=function(e){var t=this,n=h();return this.cache[e]&&n-this.cache[e].ts<this.cacheUpdateInterval?Promise.resolve(this.cache[e].value):this.kentikAPI.getFieldValues(e).then(function(r){return n=h(),t.cache[e]={ts:n,value:r},r})},e.prototype.getCustomDimensions=function(){return p(this,void 0,void 0,function(){var e,t=this;return _(this,function(n){switch(n.label){case 0:return void 0!==this.cache.customDimensions?[3,2]:[4,this.kentikAPI.getCustomDimensions()];case 1:e=n.sent(),this.cache.customDimensions=e.map(function(e){return{values:t._getDimensionPopulatorsValues(e),text:"Custom "+e.display_name,value:e.name,field:e.name}}),n.label=2;case 2:return[2,this.cache.customDimensions]}})})},e.prototype.getSavedFilters=function(){return p(this,void 0,void 0,function(){var e;return _(this,function(t){switch(t.label){case 0:return void 0!==this.cache.savedFilters?[3,2]:[4,this.kentikAPI.getSavedFilters()];case 1:e=t.sent(),this.cache.savedFilters=s.map(e,function(e){return{text:"Saved "+e.filter_name,field:e.filter_name,id:e.id}}),t.label=2;case 2:return[2,this.cache.savedFilters]}})})},e.prototype._getDimensionPopulatorsValues=function(e){return e.populators.reduce(function(e,t){return e.push(t.value),e},[])},e}();u.a.module("grafana.services").service("kentikProxySrv",m);var x=n(9),g=n.n(x),b="YYYY-MM-DD HH:mm:ss";function y(e){return"unique_src_ip"===e.value||"unique_dst_ip"===e.value?function(e){return[{name:"avg_ips",column:e.field,fn:"average",raw:!0,sample_rate:1},{name:"p95th_ips",column:e.field,fn:"percentile",rank:95,sample_rate:1},{name:"max_ips",column:e.field,fn:"max",sample_rate:1,raw:!0},{name:"p95th_bits_per_sec",column:"f_sum_both_bytes",fn:"percentile",rank:95,sample_rate:1},{name:"p95th_pkts_per_sec",column:"f_sum_both_pkts",fn:"percentile",rank:95,sample_rate:1}]}(e):function(e){return[{name:"avg_both",column:e.field,fn:"average",raw:!0,sample_rate:1},{name:"p95th_both",column:e.field,fn:"percentile",rank:95,sample_rate:1},{name:"max_both",column:e.field,fn:"max",sample_rate:1}]}(e)}function k(e,t){return"!="===e.operator&&(e.operator="<>"),{filterField:t.field,operator:e.operator,filterValue:e.value}}function S(e,t){return{filter_id:t.id,is_not:"exclude"===e.value}}var P={buildTopXdataQuery:function(e){var t=s.find(i,{value:e.unit}),n=e.range.from.utc().format(b),r=e.range.to.utc().format(b);return{dimension:[e.metric],metric:e.unit,matrixBy:[],cidr:32,cidr6:128,topx:"8",depth:100,fastData:"Auto",lookback_seconds:0,time_format:"UTC",starting_time:n,ending_time:r,device_name:e.deviceNames,outsort:t.outsort,aggregates:y(t),filters_obj:function(e){var t={connector:"All",filterGroups:[]};return e.length&&(t.filterGroups=e),t}(e.kentikFilterGroups),saved_filters:e.kentikSavedFilters}},formatAggs:y,convertToKentikFilterGroup:function(e,t,n){var r=[],i=[];if(e.length){for(var a=s.concat(o,t),u=0,l=e;u<l.length;u++){var c=l[u],d=s.find(a,{text:c.key});if(void 0===d){var f=s.find(n,{text:c.key});i.push(S(c,f))}else r.push(k(c,d))}if(r.length>0){var p="All";!e[0].condition||"or"!==e[0].condition.toLowerCase()&&"any"!==e[0].condition.toLowerCase()||(p="Any"),r=[{connector:p,filters:r,not:!1}]}}return{kentikFilters:r,savedFilters:i}}},D=function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})},A=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},w=function(){function e(e,t,n){this.instanceSettings=e,this.templateSrv=t,this.name=e.name,this.kentik=n}return e.$inject=["instanceSettings","templateSrv","kentikProxySrv"],e.prototype.interpolateDeviceField=function(e,t){return t.multi||t.includeAll?"string"==typeof e?e:e.join(","):e},e.prototype.query=function(e){return D(this,void 0,void 0,function(){var t,n,r,i,o,s,a,u;return A(this,function(l){switch(l.label){case 0:return e.targets&&0!==e.targets.length?(t=e.targets[0],n=this.templateSrv.replace(t.device,e.scopedVars,this.interpolateDeviceField.bind(this)),r=this.templateSrv.getAdhocFilters(this.name),[4,this.kentik.getCustomDimensions()]):[2,Promise.resolve({data:[]})];case 1:return i=l.sent(),[4,this.kentik.getSavedFilters()];case 2:return o=l.sent(),s=P.convertToKentikFilterGroup(r,i,o),a={deviceNames:n,range:{from:e.range.from,to:e.range.to},metric:this.templateSrv.replace(t.metric),unit:this.templateSrv.replace(t.unit),kentikFilterGroups:s.kentikFilters,kentikSavedFilters:s.savedFilters},u=P.buildTopXdataQuery(a),[2,this.kentik.invokeTopXDataQuery(u).then(this.processResponse.bind(this,u,t.mode,e)).then(function(e){return{data:e}})]}})})},e.prototype.processResponse=function(e,t,n,o){return D(this,void 0,void 0,function(){var a,u,l,c;return A(this,function(d){switch(d.label){case 0:return o.results?0===(a=o.results[0].data).length?[2,[]]:[4,this._getExtendedDimensionsList(r)]:[2,Promise.reject({message:"no kentik data"})];case 1:return u=d.sent(),l=s.find(u,{value:e.dimension[0]}),c=s.find(i,{value:e.metric}),"table"===t?[2,this.processTableData(a,l,c)]:[2,this.processTimeSeries(a,e,n)]}})})},e.prototype.processTimeSeries=function(e,t,n){var r=[],i=t.topx;e.length<i&&(i=e.length);for(var o=0;o<i;o++){var a=e[o],u=s.find(a.timeSeries,function(e){return e.flow&&e.flow.length}),l=a.key;if(u){var c={target:l,datapoints:s.map(u.flow,function(e){return[e[1],e[0]]})};r.push(c)}}return r},e.prototype.processTableData=function(e,t,n){var r=new g.a;r.columns.push({text:t.text});for(var i=0,o=n.tableFields;i<o.length;i++){var a=o[i];r.columns.push({text:a.text,unit:a.unit})}return s.forEach(e,function(e){for(var t=[e.key],i=0,o=n.tableFields;i<o.length;i++){var a=e[o[i].field];s.isString(a)&&(a=parseFloat(a)),t.push(a)}r.rows.push(t)}),[r]},e.prototype.metricFindQuery=function(e){return D(this,void 0,void 0,function(){return A(this,function(t){return"metrics()"===e?[2,this._getExtendedDimensionsList(r)]:"units()"===e?[2,i]:[2,this.kentik.getDevices().then(function(e){return e.map(function(e){return{text:e.device_name,value:e.device_name}})})]})})},e.prototype.getTagKeys=function(){return D(this,void 0,void 0,function(){var e,t;return A(this,function(n){switch(n.label){case 0:return[4,this._getExtendedDimensionsList(o)];case 1:return e=n.sent(),[4,this.kentik.getSavedFilters()];case 2:return t=n.sent(),[2,s.concat(e,t)]}})})},e.prototype.getTagValues=function(e){return D(this,void 0,void 0,function(){var t,n,r,i;return A(this,function(a){switch(a.label){case 0:return e?void 0!==(t=s.find(o,{text:e.key}))?[3,5]:[4,this.kentik.getSavedFilters()]:[3,7];case 1:return n=a.sent(),void 0!==(t=s.find(n,{text:e.key}))?[3,3]:[4,this.kentik.getCustomDimensions()];case 2:return r=a.sent(),[2,s.find(r,{text:e.key}).values.map(function(e){return{text:e}})];case 3:return[2,[{text:"include"},{text:"exclude"}]];case 4:return[3,6];case 5:return i=t.field,[2,this.kentik.getFieldValues(i).then(function(e){return e.rows.map(function(e){return{text:e[i].toString()}})})];case 6:return[3,8];case 7:return[2,[]];case 8:return[2]}})})},e.prototype._getExtendedDimensionsList=function(e){return D(this,void 0,void 0,function(){var t;return A(this,function(n){switch(n.label){case 0:return[4,this.kentik.getCustomDimensions()];case 1:return t=n.sent(),[2,s.concat(e,t)]}})})},e}(),T=function(){function e(){}return e.templateUrl="datasource/config.html",e}(),I=n(1),N=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),F=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.target.mode=r.target.mode||"graph",r.queryModes=[{value:"graph",text:"Graph"},{value:"table",text:"Table"}],r}return N(t,e),t.$inject=["$scope","$injector"],t}(I.QueryCtrl);F.templateUrl="datasource/query_editor.html",n.d(t,"Datasource",function(){return w}),n.d(t,"ConfigCtrl",function(){return T}),n.d(t,"QueryCtrl",function(){return F})}])});
//# sourceMappingURL=module.js.map