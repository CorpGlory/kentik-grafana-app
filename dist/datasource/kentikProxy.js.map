{"version":3,"sources":["../../src/datasource/kentikProxy.js"],"names":["getUTCTimestamp","ts","Date","getTime","getTimezoneOffset","getHash","queryObj","query","_","cloneDeep","starting_time","ending_time","JSON","stringify","getMaxRefreshInterval","interval","parse","moment","duration","angular","KentikProxy","backendSrv","kentikAPISrv","kentikAPI","cache","requestCachingIntervals","getDevices","bind","formatQuery","getFieldValues","cached_query","queries","hash","shouldInvoke","invokeQuery","then","timestamp","result","console","log","Promise","resolve","kentik_query","query_range","cache_starting_time","cache_ending_time","cached_query_range","max_refresh_interval","Math","abs","module","service"],"mappings":"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","file":"kentikProxy.js","sourcesContent":["import angular from 'angular';\nimport _ from 'lodash';\nimport moment from 'moment';\nimport './kentikAPI';\n\nfunction getUTCTimestamp() {\n  let ts = new Date();\n  return ts.getTime() + ts.getTimezoneOffset() * 60 * 1000;\n}\n\nfunction getHash(queryObj) {\n  let query = _.cloneDeep(queryObj);\n  query.starting_time = null;\n  query.ending_time = null;\n  return JSON.stringify(query);\n}\n\nfunction getMaxRefreshInterval(query) {\n  let interval = Date.parse(query.ending_time) - Date.parse(query.starting_time);\n  if (interval > moment.duration(1, 'months')) {\n    return 60 * 60 * 1000; // 1 hour\n  } else if (interval > moment.duration(1, 'day')) {\n    return 15 * 60 * 1000; // 15 min\n  } else {\n    return 5 * 60 * 1000; // 5 min\n  }\n}\n\nclass KentikProxy {\n  constructor(backendSrv, kentikAPISrv) {\n    this.kentikAPI = kentikAPISrv;\n    this.cache = {};\n    this.requestCachingIntervals = {\n      '1d': 0\n    };\n\n    this.getDevices = this.kentikAPI.getDevices.bind(this.kentikAPI);\n    this.formatQuery = this.kentikAPI.formatQuery.bind(this.kentikAPI);\n    this.getFieldValues = this.kentikAPI.getFieldValues.bind(this.kentikAPI);\n  }\n\n  invokeQuery(query) {\n    let cached_query = _.cloneDeep(query.queries[0].query);\n    let hash = getHash(cached_query);\n\n    if (this.shouldInvoke(query)) {\n      // Invoke query\n      return this.kentikAPI.invokeQuery(query)\n      .then(result => {\n        let timestamp = getUTCTimestamp();\n\n        this.cache[hash] = {\n          timestamp: timestamp,\n          query: cached_query,\n          result: result\n        };\n        console.log('Invoke Kentik query');\n        return result;\n      });\n    } else {\n      // Get from cache\n      console.log('Get result from cache');\n      return Promise.resolve(this.cache[hash].result);\n    }\n  }\n\n  shouldInvoke(query) {\n    let kentik_query = query.queries[0].query;\n    let hash = getHash(kentik_query);\n    let timestamp = getUTCTimestamp();\n\n    let starting_time = Date.parse(kentik_query.starting_time);\n    let ending_time = Date.parse(kentik_query.ending_time);\n    let query_range = ending_time - starting_time;\n\n    let cache_starting_time = this.cache[hash] ? Date.parse(this.cache[hash].query.starting_time) : null;\n    let cache_ending_time = this.cache[hash] ? Date.parse(this.cache[hash].query.ending_time) : null;\n    let cached_query_range = cache_ending_time - cache_starting_time;\n\n    let max_refresh_interval = getMaxRefreshInterval(kentik_query);\n\n    return (\n      !this.cache[hash] ||\n      timestamp - ending_time > max_refresh_interval ||\n      (this.cache[hash] && (\n        timestamp - cache_ending_time > max_refresh_interval ||\n        starting_time < cache_starting_time ||\n        Math.abs(query_range - cached_query_range) > 60 * 1000\n      ))\n    );\n  }\n}\n\nangular\n  .module('grafana.services')\n  .service('kentikProxySrv', KentikProxy);\n"]}