{"version":3,"sources":["../../src/datasource/datasource.js"],"names":[],"mappings":"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","file":"datasource.js","sourcesContent":["import metricList from './metric_list';\nimport _ from 'lodash';\n\nclass KentikDatasource {\n\n  constructor(instanceSettings, backendSrv, templateSrv)  {\n    this.instanceSettings = instanceSettings;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n  }\n\n  interpolateDeviceField(value, variable) {\n    // if no multi or include all do not regexEscape\n    if (!variable.multi && !variable.includeAll) {\n      return value;\n    }\n\n    if (typeof value === 'string') {\n      return value;\n    }\n\n    return value.join(',');\n  }\n\n  query(options) {\n    if (!options.targets || options.targets.length === 0) {\n      return Promise.resolve({data: []});\n    }\n\n    var target = options.targets[0];\n    var deviceNames = this.templateSrv.replace(target.device, options.scopedVars, this.interpolateDeviceField.bind(this));\n\n    var query = {\n      version: \"2.01\",\n      query: {\n        device_name: deviceNames,\n        time_type: 'fixed', // or fixed\n        lookback_seconds: 3600,\n        starting_time: options.range.from.utc().format(\"YYYY-MM-DD HH:mm:ss\"),\n        ending_time: options.range.to.utc().format(\"YYYY-MM-DD HH:mm:ss\"),\n        metric: this.templateSrv.replace(target.metric),\n        fast_data: \"Auto\", // or Fast or Full\n        // device_type: 'router', // or host,\n      },\n      filterSettings: {\n        connector: 'All',\n        filterString: '',\n        filterGroups: []\n      }\n    };\n    console.log('Kentik query: ', query);\n\n    return this.backendSrv.datasourceRequest({\n      method: 'POST',\n      url: 'api/plugin-proxy/kentik-app/api/v4/dataExplorer/timeSeriesData',\n      data: query\n    }).then(this.processResponse.bind(this, query));\n  }\n\n  processResponse(query, data) {\n    if (!data.data) {\n      return Promise.reject({message: 'no kentik data'});\n    }\n\n    var rows = data.data;\n    if (rows.length === 0) {\n      return [];\n    }\n\n    var seriesList = {};\n    var metricDef = _.findWhere(metricList, {value: query.query.metric});\n\n    for (var i = 0; i < rows.length; i++) {\n      var row = rows[i];\n      var value = row.f_sum_both_bytes;\n      var seriesName = row[metricDef.field];\n      var series = seriesList[seriesName];\n      if (!series) {\n        series = seriesList[seriesName] = {\n          target: seriesName,\n          datapoints: []\n        };\n      }\n\n      var time = new Date(row.i_start_time).getTime();\n      series.datapoints.push([value, time]);\n    }\n\n    return {\n      data: _.map(seriesList, value => {\n        return value;\n      })\n    };\n  }\n\n  metricFindQuery(query) {\n    if (query === 'metrics()') {\n      return Promise.resolve(metricList);\n    }\n\n    return this.backendSrv.datasourceRequest({\n      method: 'GET',\n      url: 'api/plugin-proxy/kentik-app/api/v1/device/list',\n    }).then(res => {\n      if (!res.data || !res.data.device) {\n        return [];\n      }\n\n      return res.data.device.map(device => {\n        return {text: device.device_name, value: device.device_name};\n      });\n    });\n  }\n}\n\nexport {KentikDatasource};\n"]}