{"version":3,"sources":["../../src/datasource/datasource.js"],"names":["metricList","unitList","filterFieldList","_","TableModel","KentikDatasource","instanceSettings","$q","backendSrv","templateSrv","name","value","variable","multi","includeAll","join","filterObj","filterField","find","text","key","field","operator","filterValue","options","targets","length","Promise","resolve","data","target","deviceNames","replace","device","scopedVars","interpolateDeviceField","bind","kentikFilters","getAdhocFilters","map","convertToKentikFilter","query","version","device_name","time_type","lookback_seconds","starting_time","range","from","utc","format","ending_time","to","metric","fast_data","units","unit","filterSettings","connector","filterString","filterGroups","filters","endpoint","mode","datasourceRequest","method","url","then","processResponse","reject","message","rows","metricDef","unitDef","processTopXData","processTimeSeries","seriesList","endIndex","rangeRaw","i","row","seriesName","series","datapoints","gfUnit","axisLabel","gfAxisLabel","transform","time","Date","i_start_time","getTime","push","table","rangeSeconds","valueOf","columns","tableFields","col","values","val","isString","parseFloat","res","devices"],"mappings":"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","file":"datasource.js","sourcesContent":["import {metricList, unitList, filterFieldList} from './metric_def';\nimport _ from 'lodash';\nimport TableModel from 'app/core/table_model';\n\nclass KentikDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv)  {\n    this.instanceSettings = instanceSettings;\n    this.name = instanceSettings.name;\n    this.$q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n  }\n\n  interpolateDeviceField(value, variable) {\n    // if no multi or include all do not regexEscape\n    if (!variable.multi && !variable.includeAll) {\n      return value;\n    }\n\n    if (typeof value === 'string') {\n      return value;\n    }\n\n    return value.join(',');\n  }\n\n  convertToKentikFilter(filterObj) {\n    return {\n      filterField: _.find(filterFieldList, {text: filterObj.key}).field,\n      operator: filterObj.operator,\n      filterValue: filterObj.value\n    };\n  }\n\n  query(options) {\n    if (!options.targets || options.targets.length === 0) {\n      return Promise.resolve({data: []});\n    }\n\n    let target = options.targets[0];\n    let deviceNames = this.templateSrv.replace(target.device, options.scopedVars, this.interpolateDeviceField.bind(this));\n\n    let kentikFilters = this.templateSrv.getAdhocFilters(this.name);\n    kentikFilters = _.map(kentikFilters, this.convertToKentikFilter);\n\n    var query = {\n      version: \"2.01\",\n      query: {\n        device_name: deviceNames,\n        time_type: 'fixed', // or fixed\n        lookback_seconds: 3600,\n        starting_time: options.range.from.utc().format(\"YYYY-MM-DD HH:mm:ss\"),\n        ending_time: options.range.to.utc().format(\"YYYY-MM-DD HH:mm:ss\"),\n        metric: this.templateSrv.replace(target.metric),\n        fast_data: \"Auto\", // or Fast or Full\n        units: this.templateSrv.replace(target.unit)\n      },\n      filterSettings: {\n        connector: 'All',\n        filterString: '',\n        filterGroups: [\n          {\n            connector: 'All',\n            filterString: \"\",\n            filters: kentikFilters\n          }\n        ]\n      }\n    };\n\n    var endpoint = 'timeSeriesData';\n    if (target.mode === 'table') {\n      endpoint = 'topXData';\n    }\n\n    return this.backendSrv.datasourceRequest({\n      method: 'POST',\n      url: 'api/plugin-proxy/kentik-app/api/v4/dataExplorer/' + endpoint,\n      data: query\n    }).then(this.processResponse.bind(this, query, endpoint, options));\n  }\n\n  processResponse(query, endpoint, options, data) {\n    if (!data.data) {\n      return Promise.reject({message: 'no kentik data'});\n    }\n\n    var rows = data.data;\n    if (rows.length === 0) {\n      return [];\n    }\n\n    var metricDef = _.find(metricList, {value: query.query.metric});\n    var unitDef = _.find(unitList, {value: query.query.units});\n\n    if (endpoint === 'topXData') {\n      return this.processTopXData(rows, metricDef, unitDef, options);\n    } else {\n      return this.processTimeSeries(rows, metricDef, unitDef, options);\n    }\n  }\n\n  processTimeSeries(rows, metricDef, unitDef, options) {\n    var seriesList = {};\n    var endIndex = rows.length;\n\n    // if time range is to now ignore last data point\n    if (options.rangeRaw.to === 'now') {\n      endIndex = endIndex - 1;\n    }\n\n    for (var i = 0; i < endIndex; i++) {\n      var row = rows[i];\n      var value = row[unitDef.field];\n      var seriesName = row[metricDef.field];\n      var series = seriesList[seriesName];\n\n      if (!series) {\n        series = seriesList[seriesName] = {\n          target: seriesName,\n          datapoints: [],\n          unit: unitDef.gfUnit,\n          axisLabel: unitDef.gfAxisLabel\n        };\n      }\n\n      if (unitDef.transform) {\n        value = unitDef.transform(value, row);\n      }\n\n      var time = new Date(row.i_start_time).getTime();\n      series.datapoints.push([value, time]);\n    }\n\n    // turn seriesList hash to array\n    return { data: _.map(seriesList, value => value) };\n  }\n\n  processTopXData(rows, metricDef, unitDef, options) {\n    var table = new TableModel();\n    var rangeSeconds = (options.range.to.valueOf() - options.range.from.valueOf()) / 1000;\n\n    table.columns.push({text: metricDef.text});\n\n    for (let col of unitDef.tableFields) {\n      table.columns.push({text: col.text, unit: col.unit});\n    }\n\n    for (let row of rows) {\n      var seriesName = row[metricDef.field];\n\n      var values = [seriesName];\n      for (let col of unitDef.tableFields) {\n        var val = row[col.field];\n        var transform = col.transform || unitDef.transform;\n\n        if (_.isString(val)) {\n          val = parseFloat(val);\n        }\n\n        if (transform) {\n          val = transform(val, row, rangeSeconds);\n        }\n\n        values.push(val);\n      }\n\n      table.rows.push(values);\n    }\n\n    return {data: [table]};\n  }\n\n  metricFindQuery(query) {\n    if (query === 'metrics()') {\n      return Promise.resolve(metricList);\n    }\n    if (query === 'units()') {\n      return Promise.resolve(unitList);\n    }\n\n    return this.backendSrv.datasourceRequest({\n      method: 'GET',\n      url: 'api/plugin-proxy/kentik-app/api/v5/devices',\n    }).then(res => {\n      if (!res.data || !res.data.devices) {\n        return [];\n      }\n\n      return res.data.devices.map(device => {\n        return {text: device.device_name, value: device.device_name};\n      });\n    });\n  }\n\n  getTagKeys() {\n    return Promise.resolve(filterFieldList);\n  }\n\n  getTagValues(options) {\n    if (options) {\n      return Promise.resolve([]);\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n}\n\nexport {KentikDatasource};\n"]}