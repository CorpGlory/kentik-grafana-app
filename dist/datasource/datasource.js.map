{"version":3,"sources":["../../src/datasource/datasource.js"],"names":["metricList","unitList","filterFieldList","_","TableModel","KentikDatasource","instanceSettings","templateSrv","kentikAPISrv","name","kentik","value","variable","multi","includeAll","join","filterObj","filterField","find","text","key","field","operator","filterValue","options","targets","length","Promise","resolve","data","target","deviceNames","replace","device","scopedVars","interpolateDeviceField","bind","kentikFilters","getAdhocFilters","map","convertToKentikFilter","query_options","range","from","to","metric","unit","query","formatV4Query","formatV5Query","endpoint","mode","invokeV5Query","then","processV5Response","reject","message","rows","metricDef","unitDef","units","processTopXData","processTimeSeries","results","bucketData","queries","dimension","processTableData","processV5TimeSeries","seriesList","endIndex","topx","i","series","timeseries","timeSeries","flow","seriesName","grafana_series","datapoints","point","push","table","columns","tableFields","col","forEach","row","values","val","isString","parseFloat","rangeRaw","gfUnit","axisLabel","gfAxisLabel","transform","time","Date","i_start_time","getTime","rangeSeconds","valueOf","getDevices","devices","device_name"],"mappings":"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","file":"datasource.js","sourcesContent":["import {metricList, unitList, filterFieldList} from './metric_def';\nimport _ from 'lodash';\nimport TableModel from 'app/core/table_model';\nimport './kentikAPI';\n\nclass KentikDatasource {\n\n  constructor(instanceSettings, templateSrv, kentikAPISrv)  {\n    this.instanceSettings = instanceSettings;\n    this.name = instanceSettings.name;\n    this.templateSrv = templateSrv;\n    this.kentik = kentikAPISrv;\n  }\n\n  interpolateDeviceField(value, variable) {\n    // if no multi or include all do not regexEscape\n    if (!variable.multi && !variable.includeAll) {\n      return value;\n    }\n\n    if (typeof value === 'string') {\n      return value;\n    }\n\n    return value.join(',');\n  }\n\n  convertToKentikFilter(filterObj) {\n    return {\n      filterField: _.find(filterFieldList, {text: filterObj.key}).field,\n      operator: filterObj.operator,\n      filterValue: filterObj.value\n    };\n  }\n\n  query(options) {\n    if (!options.targets || options.targets.length === 0) {\n      return Promise.resolve({data: []});\n    }\n\n    let target = options.targets[0];\n    let deviceNames = this.templateSrv.replace(target.device, options.scopedVars, this.interpolateDeviceField.bind(this));\n\n    let kentikFilters = this.templateSrv.getAdhocFilters(this.name);\n    kentikFilters = _.map(kentikFilters, this.convertToKentikFilter);\n\n    let query_options = {\n      deviceNames: deviceNames,\n      range: {\n        from: options.range.from,\n        to: options.range.to\n      },\n      metric: this.templateSrv.replace(target.metric),\n      unit: this.templateSrv.replace(target.unit),\n      kentikFilters: kentikFilters\n    };\n    let query = this.kentik.formatV4Query(query_options);\n    query = this.kentik.formatV5Query(query_options);\n\n    let endpoint = 'timeSeriesData';\n    endpoint = 'topXdata';\n    if (target.mode === 'table') {\n      endpoint = 'topXdata';\n    }\n\n    return this.kentik.invokeV5Query(query, endpoint)\n    .then(this.processV5Response.bind(this, query, target.mode, options));\n  }\n\n  processResponse(query, endpoint, options, data) {\n    if (!data.data) {\n      return Promise.reject({message: 'no kentik data'});\n    }\n\n    var rows = data.data;\n    if (rows.length === 0) {\n      return [];\n    }\n\n    var metricDef = _.find(metricList, {value: query.query.metric});\n    var unitDef = _.find(unitList, {value: query.query.units});\n\n    if (endpoint === 'topXData') {\n      return this.processTopXData(rows, metricDef, unitDef, options);\n    } else {\n      return this.processTimeSeries(rows, metricDef, unitDef, options);\n    }\n  }\n\n  processV5Response(query, mode, options, data) {\n    if (!data.data.results) {\n      return Promise.reject({message: 'no kentik data'});\n    }\n\n    var bucketData = data.data.results[0].data;\n    if (bucketData.length === 0) {\n      return [];\n    }\n\n    var metricDef = _.find(metricList, {value: query.queries[0].query.dimension[0]});\n    var unitDef = _.find(unitList, {value: query.queries[0].query.metric});\n\n    if (mode === 'table') {\n      return this.processTableData(bucketData, metricDef, unitDef);\n    } else {\n      return this.processV5TimeSeries(bucketData, query, options);\n    }\n  }\n\n  processV5TimeSeries(bucketData, query) {\n    let seriesList = [];\n    let endIndex = query.queries[0].query.topx;\n    if (bucketData.length < endIndex) {\n      endIndex = bucketData.length;\n    }\n\n    for (let i = 0; i < endIndex; i++) {\n      let series = bucketData[i];\n      let timeseries = _.find(series.timeSeries, series => {\n        return series.flow && series.flow.length;\n      });\n      let seriesName = series.key;\n\n      if (timeseries) {\n        let grafana_series = {\n          target: seriesName,\n          datapoints: timeseries.flow.map(point => {\n            return [point[1], point[0]];\n          })\n        };\n        seriesList.push(grafana_series);\n      }\n    }\n\n    return { data: seriesList };\n  }\n\n  processTableData(bucketData, metricDef, unitDef) {\n    var table = new TableModel();\n\n    table.columns.push({text: metricDef.text});\n\n    for (let col of unitDef.tableFields) {\n      table.columns.push({text: col.text, unit: col.unit});\n    }\n\n    bucketData.forEach(row => {\n      var seriesName = row.key;\n\n      var values = [seriesName];\n      for (let col of unitDef.tableFields) {\n        var val = row[col.field];\n\n        if (_.isString(val)) {\n          val = parseFloat(val);\n        }\n\n        values.push(val);\n      }\n\n      table.rows.push(values);\n    });\n\n    return {data: [table]};\n  }\n\n  processTimeSeries(rows, metricDef, unitDef, options) {\n    var seriesList = {};\n    var endIndex = rows.length;\n\n    // if time range is to now ignore last data point\n    if (options.rangeRaw.to === 'now') {\n      endIndex = endIndex - 1;\n    }\n\n    for (var i = 0; i < endIndex; i++) {\n      var row = rows[i];\n      var value = row[unitDef.field];\n      var seriesName = row[metricDef.field];\n      var series = seriesList[seriesName];\n\n      if (!series) {\n        series = seriesList[seriesName] = {\n          target: seriesName,\n          datapoints: [],\n          unit: unitDef.gfUnit,\n          axisLabel: unitDef.gfAxisLabel\n        };\n      }\n\n      if (unitDef.transform) {\n        value = unitDef.transform(value, row);\n      }\n\n      var time = new Date(row.i_start_time).getTime();\n      series.datapoints.push([value, time]);\n    }\n\n    // turn seriesList hash to array\n    return { data: _.map(seriesList, value => value) };\n  }\n\n  processTopXData(rows, metricDef, unitDef, options) {\n    var table = new TableModel();\n    var rangeSeconds = (options.range.to.valueOf() - options.range.from.valueOf()) / 1000;\n\n    table.columns.push({text: metricDef.text});\n\n    for (let col of unitDef.tableFields) {\n      table.columns.push({text: col.text, unit: col.unit});\n    }\n\n    for (let row of rows) {\n      var seriesName = row[metricDef.field];\n\n      var values = [seriesName];\n      for (let col of unitDef.tableFields) {\n        var val = row[col.field];\n        var transform = col.transform || unitDef.transform;\n\n        if (_.isString(val)) {\n          val = parseFloat(val);\n        }\n\n        if (transform) {\n          val = transform(val, row, rangeSeconds);\n        }\n\n        values.push(val);\n      }\n\n      table.rows.push(values);\n    }\n\n    return {data: [table]};\n  }\n\n  metricFindQuery(query) {\n    if (query === 'metrics()') {\n      return Promise.resolve(metricList);\n    }\n    if (query === 'units()') {\n      return Promise.resolve(unitList);\n    }\n\n    return this.kentik.getDevices()\n    .then(devices => {\n      return devices.map(device => {\n        return {text: device.device_name, value: device.device_name};\n      });\n    });\n  }\n\n  getTagKeys() {\n    return Promise.resolve(filterFieldList);\n  }\n\n  getTagValues(options) {\n    if (options) {\n      return Promise.resolve([]);\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n}\n\nexport {KentikDatasource};\n"]}